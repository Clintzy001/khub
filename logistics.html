<!DOCTYPE html>
<html lang="en" id="htmlTag">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KHUB | Logistics (Cloud)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { --brand: #4A148C; --accent: #FFAB00; }
        #htmlTag.dark body { background-color: #000000 !important; color: white; }
        #htmlTag.dark .themed-card { background-color: #121212; border-color: #222; }
        #htmlTag.dark .themed-input { color: white !important; border-bottom-color: #333; }
        #htmlTag.dark .logistics-icon-bg { background-color: #121212 !important; color: #BA68C8 !important; border: 1px solid #333; }
        .text-brand { color: var(--brand); }
        
        .service-btn.active .logistics-icon-bg { background-color: var(--brand) !important; color: white !important; transform: scale(1.1); box-shadow: 0 10px 20px rgba(74, 20, 140, 0.3); }
        .service-btn.active span { color: var(--brand); font-weight: 900; }
        
        body { background-color: #F9FAFB; transition: 0.3s ease; overflow-x: hidden; }
        .bg-brand { background-color: var(--brand); }
        .themed-card { background-color: #ffffff; border-color: #F3F4F6; transition: 0.3s; }
        .themed-input { background-color: transparent; outline: none; border-bottom: 1px solid #ddd; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .pulse-btn { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(74, 20, 140, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(74, 20, 140, 0); } 100% { box-shadow: 0 0 0 0 rgba(74, 20, 140, 0); } }
        
        #driverModal, #receiptModal { display: none; position: fixed; inset: 0; z-index: 100; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); align-items: center; justify-content: center; padding: 20px; }
        #driverModal.active, #receiptModal.active { display: flex; }
        
        #fleetMap { height: 250px; width: 100%; border-radius: 35px; z-index: 10; overflow: hidden; }
        .leaflet-container { background: transparent !important; }

        .price-badge { background: linear-gradient(135deg, #4A148C, #7B1FA2); color: white; padding: 4px 12px; border-radius: 12px; font-weight: 900; font-size: 14px; }
        
        .receipt-paper { background: white; color: #333; border-radius: 20px; position: relative; overflow: hidden; }
        .receipt-paper::before { content: ""; position: absolute; top: 0; left: 0; right: 0; height: 8px; background: repeating-linear-gradient(-45deg, var(--brand), var(--brand) 10px, #BA68C8 10px, #BA68C8 20px); }

        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; pointer-events: none; }
        .toast { background: #4A148C; color: white; padding: 12px 24px; border-radius: 50px; font-weight: 900; font-size: 10px; text-transform: uppercase; margin-bottom: 10px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="pb-32 font-sans transition-colors duration-300">

    <div id="toast-container"></div>

    <div id="receiptModal">
        <div class="receipt-paper w-full max-w-xs p-6 shadow-2xl scale-95 transition-transform duration-300">
            <div class="text-center border-bottom pb-4 mb-4 border-dashed border-gray-200">
                <h2 class="font-black text-brand text-xl">KHUB RECEIPT</h2>
                <p class="text-[10px] font-bold opacity-60 uppercase" id="receiptDate"></p>
            </div>
            <div class="space-y-3 text-sm">
                <div class="flex justify-between"><span class="opacity-50 font-bold uppercase text-[10px]">Service</span><span class="font-black text-right" id="recService"></span></div>
                <div class="flex justify-between"><span class="opacity-50 font-bold uppercase text-[10px]">Pickup</span><span class="font-black text-right" id="recPickup"></span></div>
                <div class="flex justify-between"><span class="opacity-50 font-bold uppercase text-[10px]">Dropoff</span><span class="font-black text-right" id="recDropoff"></span></div>
                <div class="border-t border-dashed pt-3 mt-3 flex justify-between items-center">
                    <span class="font-black text-brand uppercase text-[10px]">Total Paid</span>
                    <span class="text-xl font-black text-brand" id="recPrice"></span>
                </div>
            </div>
            <div class="mt-6 flex flex-col gap-2">
                <button onclick="closeReceipt()" class="w-full bg-brand text-white py-3 rounded-xl font-black text-[10px] uppercase">Finish Booking</button>
                <p class="text-[8px] text-center font-bold opacity-40 uppercase">Thank you for choosing KHUB Logistics</p>
            </div>
        </div>
    </div>

    <div id="driverModal">
        <div class="bg-white dark:bg-zinc-900 w-full max-w-md p-8 rounded-[40px] shadow-2xl relative border dark:border-zinc-800">
            <button onclick="toggleDriverModal()" class="absolute top-6 right-6 text-gray-400"><i class="fas fa-times text-xl"></i></button>
            <h2 class="text-xl font-black text-brand dark:text-purple-400 uppercase mb-2">Driver Onboarding</h2>
            <p class="text-[10px] font-bold opacity-60 uppercase mb-6 tracking-widest text-black dark:text-white">Join our verified fleet</p>
            <div class="space-y-4">
                <input type="text" id="regName" placeholder="Full Name" class="w-full py-3 themed-input text-sm font-bold">
                <input type="text" id="regVehicle" placeholder="Vehicle (Bike/Car/Van)" class="w-full py-3 themed-input text-sm font-bold">
                <input type="text" id="regLocation" placeholder="Operating Area (e.g. Kano)" class="w-full py-3 themed-input text-sm font-bold">
                <button onclick="submitDriverReg()" class="w-full bg-brand text-white py-4 rounded-2xl font-black text-xs uppercase shadow-lg mt-4 active:scale-95 transition-all">Join KHUB Fleet</button>
            </div>
        </div>
    </div>

    <header class="bg-brand text-white px-6 py-6 rounded-b-[40px] shadow-lg">
        <div class="flex justify-between items-start mb-6">
            <div onclick="handleAdminTrigger()">
                <h1 class="text-2xl font-black italic tracking-tighter uppercase cursor-pointer">KHUB LOGISTICS</h1>
                <p id="adminStatus" class="text-[10px] uppercase font-bold opacity-80">Cloud Infrastructure v4.2</p>
            </div>
            <button onclick="toggleDarkMode()" class="w-10 h-10 bg-white/10 rounded-xl flex items-center justify-center border border-white/20">
                <i id="themeIcon" class="fas fa-moon"></i>
            </button>
        </div>
        <div class="relative mt-4">
            <input type="text" id="trackingInput" placeholder="Enter Tracking ID (e.g. KH-101)..." class="w-full py-4 px-6 rounded-2xl font-bold text-sm outline-none shadow-xl text-gray-900">
            <button onclick="trackPackage()" class="absolute right-2 top-2 bg-brand p-2 px-4 rounded-xl text-white text-xs font-black uppercase">Track</button>
        </div>
    </header>

    <main class="px-6 mt-8">
        <div id="searchHistoryBox" class="hidden mb-6">
            <div class="flex justify-between items-center mb-2">
                <h3 class="font-black text-[10px] uppercase text-gray-400 tracking-widest flex items-center gap-2">
                    <i class="fas fa-history text-brand"></i> Recent Searches
                </h3>
                <button onclick="clearHistory()" class="text-[9px] font-bold text-red-500 uppercase flex items-center gap-1">
                    <i class="fas fa-trash-alt"></i> Clear
                </button>
            </div>
            <div id="historyBadges" class="flex flex-wrap gap-2"></div>
        </div>

        <div id="trackingResult" class="hidden themed-card p-5 rounded-[30px] border-2 border-brand mb-6 shadow-xl">
            <div class="flex justify-between items-start">
                <p class="text-[10px] font-black uppercase text-brand">Order Intelligence</p>
                <button onclick="document.getElementById('trackingResult').classList.add('hidden')" class="text-gray-400 text-xs">Close</button>
            </div>
            <div class="mt-2 space-y-2">
                <h3 id="trackStatus" class="text-lg font-black text-black dark:text-white uppercase leading-tight"></h3>
                <p id="trackDetails" class="text-[11px] font-bold opacity-70 text-black dark:text-white uppercase tracking-tighter"></p>
                
                <div id="adminOrderControls" class="hidden pt-4 border-t mt-4 space-y-3">
                    <input type="text" id="editStatus" placeholder="New Status" class="w-full text-xs p-2 themed-input font-bold">
                    <input type="text" id="editLocation" placeholder="New Location" class="w-full text-xs p-2 themed-input font-bold">
                    <button id="orderActionBtn" class="w-full bg-brand text-white py-2 rounded-xl text-[10px] font-black uppercase shadow-md"></button>
                </div>
            </div>
        </div>

        <div class="mb-8">
            <h3 class="font-black text-[10px] uppercase text-gray-500 dark:text-gray-400 mb-4 flex justify-between items-center tracking-widest">
                <span><i class="fas fa-map-marked-alt text-brand"></i> Real-Time Distribution</span>
                <button onclick="locateUser()" class="text-brand bg-brand/10 p-2 px-3 rounded-full text-[9px] font-black">LOCATE ME</button>
            </h3>
            <div id="fleetMap" class="shadow-xl border-2 border-brand/10"></div>
        </div>

        <div class="flex gap-4 overflow-x-auto no-scrollbar py-2 mb-6">
            <div class="service-btn active flex flex-col items-center gap-2" onclick="selectService(this, 'Deliver Package')">
                <div class="logistics-icon-bg w-14 h-14 bg-white shadow-lg rounded-[22px] flex items-center justify-center text-brand text-xl transition-all">
                    <i class="fas fa-box-open"></i>
                </div>
                <span class="text-[9px] font-black uppercase tracking-tighter">Deliver</span>
            </div>
            <div class="service-btn flex flex-col items-center gap-2" onclick="selectService(this, 'Dispatch Rider')">
                <div class="logistics-icon-bg w-14 h-14 bg-white shadow-lg rounded-[22px] flex items-center justify-center text-brand text-xl transition-all">
                    <i class="fas fa-motorcycle"></i>
                </div>
                <span class="text-[9px] font-black uppercase tracking-tighter">Dispatch</span>
            </div>
            <div class="service-btn flex flex-col items-center gap-2" onclick="selectService(this, 'Inter-State')">
                <div class="logistics-icon-bg w-14 h-14 bg-white shadow-lg rounded-[22px] flex items-center justify-center text-brand text-xl transition-all">
                    <i class="fas fa-route"></i>
                </div>
                <span class="text-[9px] font-black uppercase tracking-tighter">Inter-State</span>
            </div>
        </div>

        <div class="themed-card p-6 rounded-3xl shadow-sm border mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-sm font-black uppercase text-brand">Instant Request</h2>
                <div id="costDisplay" class="price-badge">₦0.00</div>
            </div>
            <div class="space-y-4">
                <input type="text" id="pickup" oninput="calculatePrice()" placeholder="Pickup Address" class="w-full py-2 text-sm font-bold themed-input">
                <input type="text" id="dropoff" placeholder="Dropoff Address" class="w-full py-2 text-sm font-bold themed-input">
            </div>
            <button onclick="bookGeneral()" class="w-full mt-6 bg-brand text-white py-4 rounded-2xl font-black text-sm uppercase shadow-lg active:scale-95 transition-all">Book KHUB Now</button>
        </div>

        <div class="mb-8 relative overflow-hidden bg-gradient-to-br from-purple-900 to-brand p-5 rounded-[35px] shadow-xl border border-white/10">
            <div class="flex items-center justify-between z-10 relative">
                <div class="max-w-[65%]">
                    <h3 class="text-white text-lg font-black uppercase tracking-tighter leading-none">Safety Shield</h3>
                    <p class="text-white/70 text-[10px] font-bold uppercase mt-2">Every driver is verified by KHUB HQ</p>
                </div>
                <div class="bg-white/20 w-14 h-14 rounded-full flex items-center justify-center backdrop-blur-md">
                    <i class="fas fa-user-shield text-xl text-yellow-400 animate-pulse"></i>
                </div>
            </div>
        </div>

        <div class="flex justify-between items-center mb-4">
            <h3 class="font-black text-sm uppercase text-brand flex items-center gap-2">
                <i class="fas fa-check-circle text-green-500"></i> Active Fleet
            </h3>
            <button id="addDriverBtn" onclick="addNewDriver()" class="hidden bg-brand text-white text-[9px] px-4 py-2 rounded-full font-black uppercase shadow-lg">+ Add Driver</button>
        </div>
        <div id="driversList" class="space-y-4 mb-10"></div>
    </main>

    <nav class="fixed bottom-0 w-full bg-white/90 dark:bg-black/90 backdrop-blur-lg border-t dark:border-zinc-800 flex justify-around items-center py-4 z-50">
        <a href="shop.html" class="flex flex-col items-center text-brand dark:text-purple-400">
            <i class="fas fa-bag-shopping text-xl"></i>
            <span class="text-[8px] font-bold mt-1 uppercase">Market</span>
        </a>
        <div class="relative -top-6">
            <div onclick="toggleDriverModal()" class="bg-brand w-14 h-14 rounded-full shadow-2xl text-white border-4 border-white dark:border-black flex items-center justify-center pulse-btn cursor-pointer">
                <i class="fas fa-plus text-xl text-[#FFAB00]"></i>
            </div>
        </div>
        <div onclick="window.open('https://wa.me/2347051337399')" class="flex flex-col items-center text-gray-400 cursor-pointer">
            <i class="fab fa-whatsapp text-xl text-green-500"></i>
            <span class="text-[8px] font-bold mt-1 uppercase">Chat</span>
        </div>
    </nav>

    <script>
        const SUPABASE_URL = 'https://qsmfskpcthydqrvbrcfy.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzbWZza3BjdGh5ZHFydmJyY2Z5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2OTQzMjUsImV4cCI6MjA4MzI3MDMyNX0.hA0W_kpQ1Irfoj2DRu5Nv0T_8ojb2YzX9g9g_UYgpuA';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let isAdmin = localStorage.getItem('khub_admin') === 'true';
        let adminClicks = 0;
        let loginAttempts = 0; // New: track failed attempts
        let selectedService = "Deliver Package";
        let currentPrice = 0;
        const defaultWA = "2347051337399";
        let map, markersLayer;

        const cityCoords = { "Kano": [12.0022, 8.5920], "Lagos": [6.5244, 3.3792], "Abuja": [9.0765, 7.3986], "Kaduna": [10.5105, 7.4165] };

        // --- Core Functions ---

        function showToast(msg) {
            const container = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = 'toast';
            t.innerText = msg;
            container.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        function handleAdminTrigger() {
            // Check if locked out (Lockout duration: 5 minutes)
            const lockoutTime = localStorage.getItem('admin_lockout');
            if (lockoutTime) {
                const minutesPassed = (Date.now() - lockoutTime) / 60000;
                if (minutesPassed < 5) {
                    showToast(`Locked out. Try in ${Math.ceil(5 - minutesPassed)}m`);
                    return;
                } else {
                    localStorage.removeItem('admin_lockout');
                    loginAttempts = 0;
                }
            }

            adminClicks++;
            if (adminClicks === 3) {
                const pin = prompt("Admin PIN:");
                
                if (pin === "825032") {
                    isAdmin = true;
                    loginAttempts = 0;
                    localStorage.setItem('khub_admin', 'true');
                    updateAdminUI();
                    showToast("Admin Session Started");
                } else if (pin !== null) {
                    loginAttempts++;
                    showToast(`Incorrect. ${5 - loginAttempts} attempts left.`);
                    if (loginAttempts >= 5) {
                        localStorage.setItem('admin_lockout', Date.now());
                        showToast("Security Lockout Triggered.");
                    }
                }
                adminClicks = 0;
            }
            setTimeout(() => adminClicks = 0, 1500);
        }

        function updateAdminUI() {
            if(isAdmin) {
                document.getElementById('adminStatus').innerText = "SYSTEM ADMIN ACTIVE";
                document.getElementById('adminStatus').classList.add('text-yellow-400');
                document.getElementById('addDriverBtn').classList.remove('hidden');
                renderDrivers();
            }
        }

        // --- All existing functions (renderDrivers, trackPackage, etc.) remain unchanged ---

        async function renderDrivers() {
            const container = document.getElementById('driversList');
            try {
                const { data, error } = await _supabase.from('logistics').select('*').order('rating', { ascending: false });
                if (error) throw error;
                container.innerHTML = '';
                markersLayer.clearLayers();
                data.forEach(d => {
                    const color = d.rating >= 4.5 ? "bg-green-500" : "bg-orange-500";
                    if(cityCoords[d.vehicle]) { L.circleMarker(cityCoords[d.vehicle], { color: '#4A148C', radius: 8, fillOpacity: 0.8 }).addTo(markersLayer); }
                    container.innerHTML += `
                        <div class="themed-card p-4 rounded-3xl border border-gray-100 dark:border-zinc-800 flex items-center gap-4 relative shadow-sm transition-all">
                            ${isAdmin ? `<button onclick="deleteDriver('${d.id}')" class="absolute -top-1 -right-1 bg-red-600 text-white w-6 h-6 rounded-full text-[10px]">×</button>` : ''}
                            <div class="relative">
                                <img src="https://ui-avatars.com/api/?name=${d.name}&background=fff&color=4A148C" class="w-14 h-14 rounded-2xl object-cover border-2 border-brand/10">
                                <div class="absolute -bottom-1 -right-1 w-4 h-4 ${color} border-4 border-white dark:border-black rounded-full"></div>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-black text-sm uppercase text-brand leading-tight">${d.name}</h4>
                                <p class="text-[8px] font-bold text-gray-400 uppercase mt-1">★ ${d.rating} • ${d.vehicle || 'Kano'}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="window.open('https://wa.me/${d.whatsapp}')" class="bg-green-500 text-white w-10 h-10 rounded-xl flex items-center justify-center shadow-lg"><i class="fab fa-whatsapp"></i></button>
                                <button onclick="window.open('tel:${d.whatsapp}')" class="bg-brand text-white w-10 h-10 rounded-xl flex items-center justify-center shadow-lg"><i class="fas fa-phone-alt"></i></button>
                            </div>
                        </div>`;
                });
            } catch (err) { showToast("Fleet sync failed"); }
        }

        async function trackPackage() {
            const id = document.getElementById('trackingInput').value.trim().toUpperCase();
            if(!id) return;
            const resBox = document.getElementById('trackingResult');
            try {
                const { data, error } = await _supabase.from('orders').select('*').eq('tracking_id', id).single();
                resBox.classList.remove('hidden');
                if (data) {
                    document.getElementById('trackStatus').innerText = `Status: ${data.status}`;
                    document.getElementById('trackDetails').innerText = `Current Location: ${data.location}`;
                    if(isAdmin) {
                        document.getElementById('adminOrderControls').classList.remove('hidden');
                        document.getElementById('orderActionBtn').innerText = "Sync Changes";
                        document.getElementById('orderActionBtn').onclick = () => updateOrder(id);
                    }
                } else {
                    document.getElementById('trackStatus').innerText = "Not Found";
                    if(isAdmin) {
                        document.getElementById('adminOrderControls').classList.remove('hidden');
                        document.getElementById('orderActionBtn').innerText = "Register New";
                        document.getElementById('orderActionBtn').onclick = () => createOrder(id);
                    }
                }
            } catch (err) { showToast("Track error"); }
        }

        function calculatePrice() {
            const input = document.getElementById('pickup').value.toLowerCase();
            let base = selectedService === 'Inter-State' ? 5000 : (selectedService === 'Dispatch Rider' ? 1500 : 1000);
            currentPrice = Math.floor(base * (input.length > 5 ? 1.2 : 1));
            document.getElementById('costDisplay').innerText = `₦${currentPrice.toLocaleString()}`;
        }

        function selectService(el, s) { 
            document.querySelectorAll('.service-btn').forEach(b => b.classList.remove('active')); 
            el.classList.add('active'); 
            selectedService = s; calculatePrice();
        }

        function toggleDarkMode() {
            const isNowDark = document.getElementById('htmlTag').classList.toggle('dark');
            localStorage.setItem('khub_theme', isNowDark ? 'dark' : 'light');
            applyTheme();
        }

        function applyTheme() {
            const isDark = localStorage.getItem('khub_theme') === 'dark';
            document.getElementById('htmlTag').classList.toggle('dark', isDark);
            if(map) updateMapStyle(isDark);
        }

        function initMap() {
            map = L.map('fleetMap', { zoomControl: false }).setView([12.0022, 8.5920], 11);
            updateMapStyle(document.getElementById('htmlTag').classList.contains('dark'));
            markersLayer = L.layerGroup().addTo(map);
        }

        function updateMapStyle(isDark) {
            const style = isDark ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png' : 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
            L.tileLayer(style).addTo(map);
        }

        function toggleDriverModal() { document.getElementById('driverModal').classList.toggle('active'); }
        function closeReceipt() { document.getElementById('receiptModal').classList.remove('active'); }
        function bookGeneral() { showToast("Generating Ticket..."); generateReceipt(); }
        function generateReceipt() {
            document.getElementById('receiptDate').innerText = new Date().toLocaleString();
            document.getElementById('recService').innerText = selectedService;
            document.getElementById('recPickup').innerText = document.getElementById('pickup').value || "Hub";
            document.getElementById('recDropoff').innerText = document.getElementById('dropoff').value || "Hub";
            document.getElementById('recPrice').innerText = `₦${currentPrice.toLocaleString()}`;
            document.getElementById('receiptModal').classList.add('active');
        }

        window.onload = () => { applyTheme(); initMap(); updateAdminUI(); renderDrivers(); renderHistory(); };
    </script>
</body>
</html>
