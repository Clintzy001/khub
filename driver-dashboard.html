<!DOCTYPE html>
<html lang="en" id="htmlTag">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Dashboard | K-HUB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800;900&display=swap" rel="stylesheet">

    <style>
        :root { --brand: #4b1b7c; --brand-light: #6d2fd1; --gold: #FFD700; }
        body { font-family: 'Poppins', sans-serif; background-color: #f7f7fb; transition: 0.3s; }
        .dark body { background-color: #0f0f1a; color: white; }
        .brand-purple { background-color: var(--brand); }
        .text-brand { color: var(--brand); }
        .dark .text-brand { color: #a78bfa; } 
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        .dark .glass-card { background: rgba(30, 30, 46, 0.8); border: 1px solid rgba(255,255,255,0.05); }
        .promote-gradient { background: linear-gradient(135deg, #FFD700 0%, #B8860B 100%); color: #000; }
        
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #25D366; }
        input:checked + .slider:before { transform: translateX(24px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="pb-32">

    <header class="brand-purple text-white px-6 py-6 rounded-b-[40px] shadow-lg sticky top-0 z-40">
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-4">
                <a href="index.html" class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center">
                    <i class="fas fa-arrow-left text-sm"></i>
                </a>
                <div class="flex items-center gap-3">
                    <div class="relative w-12 h-12 cursor-pointer group" onclick="document.getElementById('driverInput').click()">
                        <img id="driverImg" src="https://ui-avatars.com/api/?name=Driver&background=6d2fd1&color=fff" class="w-full h-full rounded-2xl object-cover border-2 border-white/20">
                        <input type="file" id="driverInput" class="hidden" accept="image/*" onchange="previewImage(this, 'driverImg')">
                    </div>
                    <div>
                        <div class="flex items-center gap-2">
                            <input type="text" id="driverName" onblur="saveDriverProfile()" placeholder="Driver Name" class="bg-transparent border-none outline-none text-lg font-black italic uppercase leading-none w-32 placeholder-white/50">
                            <i id="verifyBadge" class="fas fa-check-circle text-blue-400 hidden"></i>
                        </div>
                        <p class="text-[9px] font-bold opacity-70 tracking-widest uppercase mt-1">ID: <span id="driverID">DR-0000</span></p>
                    </div>
                </div>
            </div>
            <button onclick="toggleTheme()" class="w-10 h-10 bg-white/10 rounded-xl flex items-center justify-center border border-white/20">
                <i id="themeIcon" class="fas fa-moon"></i>
            </button>
        </div>

        <div class="grid grid-cols-3 gap-3">
            <div class="bg-white/10 p-3 rounded-2xl text-center border border-white/10">
                <p class="text-[8px] font-bold uppercase opacity-60">Status</p>
                <h3 class="text-[9px] font-black uppercase" id="statusLabel">Online</h3>
            </div>
            <div class="bg-white/10 p-3 rounded-2xl text-center border border-white/10">
                <p class="text-[8px] font-bold uppercase opacity-60">Earnings</p>
                <h3 class="text-base font-black">₦<span id="totalEarnings">0</span></h3>
            </div>
            <div class="bg-white/10 p-3 rounded-2xl text-center border border-white/10">
                <p class="text-[8px] font-bold uppercase opacity-60">Active</p>
                <h3 class="text-base font-black" id="routeCount">0</h3>
            </div>
        </div>
    </header>

    <main class="p-6">
        <div class="glass-card p-5 rounded-[30px] mb-6 flex items-center justify-between border-2 border-brand/10">
            <div>
                <h3 class="text-[11px] font-black uppercase text-brand">Live Availability</h3>
                <p id="availDesc" class="text-[9px] font-bold text-green-500">You are visible to riders</p>
            </div>
            <label class="switch">
                <input type="checkbox" id="availToggle" checked onclick="updateAvailability()">
                <span class="slider"></span>
            </label>
        </div>

        <div class="flex gap-4 mb-6">
            <button onclick="switchTab('active')" id="tabActive" class="text-[10px] font-black uppercase pb-2 border-b-2 border-brand text-brand">My Routes</button>
            <button onclick="switchTab('history')" id="tabHistory" class="text-[10px] font-black uppercase pb-2 border-b-2 border-transparent opacity-40">Trip History</button>
        </div>

        <div id="activeContent">
            <div id="promoBanner" class="promote-gradient p-5 rounded-[30px] mb-8 shadow-lg flex justify-between items-center transition-transform active:scale-95 cursor-pointer" onclick="openPromoModal()">
                <div class="w-2/3">
                    <h2 class="text-sm font-black uppercase leading-tight">Get Verified Badge</h2>
                    <p class="text-[9px] font-bold opacity-90 mt-1">Pay ₦5,000 to unlock the gold badge and trust.</p>
                </div>
                <div class="bg-black text-white px-3 py-2 rounded-xl text-[9px] font-black uppercase shadow-lg">Pay Now</div>
            </div>

            <div class="flex justify-between items-center mb-4">
                <h2 class="font-black uppercase text-[10px] tracking-widest text-gray-500">Live Trips</h2>
                <button onclick="togglePostModal()" class="brand-purple text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase shadow-lg">
                    <i class="fas fa-plus mr-1"></i> Post Trip
                </button>
            </div>

            <div id="route-listings" class="space-y-4">
                <div class="text-center py-20 opacity-20 font-black uppercase text-[10px]">Syncing...</div>
            </div>
        </div>

        <div id="historyContent" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <button onclick="downloadHistory()" class="text-[9px] font-black uppercase bg-gray-100 dark:bg-zinc-800 dark:text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-download mr-1"></i> Receipt
                </button>
                <button onclick="clearHistory()" class="text-[9px] font-black uppercase text-red-500 bg-red-50 dark:bg-red-900/10 px-4 py-2 rounded-lg">
                    <i class="fas fa-trash mr-1"></i> Clear
                </button>
            </div>
            <div id="history-list" class="space-y-4"></div>
        </div>
    </main>

    <div id="postModal" class="fixed inset-0 bg-white dark:bg-zinc-900 z-[70] p-6 hidden flex-col overflow-y-auto no-scrollbar">
        <div class="flex justify-between items-center mb-6">
            <h2 id="modalTitle" class="text-xl font-black uppercase dark:text-white">New Trip</h2>
            <button onclick="togglePostModal()" class="w-10 h-10 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center dark:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="space-y-4 pb-10">
            <input type="hidden" id="editRouteId">
            <input type="text" id="rFrom" placeholder="Pickup Point" class="w-full p-4 bg-gray-50 dark:bg-zinc-800 rounded-2xl dark:text-white outline-none font-bold text-sm">
            <input type="text" id="rTo" placeholder="Destination" class="w-full p-4 bg-gray-50 dark:bg-zinc-800 rounded-2xl dark:text-white outline-none font-bold text-sm">
            <div class="grid grid-cols-2 gap-3">
                <input type="text" id="rPlate" placeholder="Plate No" class="p-4 bg-gray-50 dark:bg-zinc-800 rounded-2xl dark:text-white outline-none font-bold text-sm">
                <input type="text" id="rColor" placeholder="Car Color" class="p-4 bg-gray-50 dark:bg-zinc-800 rounded-2xl dark:text-white outline-none font-bold text-sm">
            </div>
            <div class="grid grid-cols-2 gap-3">
                <input type="text" id="rPrice" placeholder="Fare (₦)" class="p-4 bg-gray-50 dark:bg-zinc-800 rounded-2xl dark:text-white outline-none font-bold text-sm">
                <input type="number" id="rSeats" placeholder="Seats" class="p-4 bg-gray-50 dark:bg-zinc-800 rounded-2xl dark:text-white outline-none font-bold text-sm">
            </div>
            <input type="text" id="rWa" placeholder="WhatsApp (234...)" class="w-full p-4 bg-gray-50 dark:bg-zinc-800 rounded-2xl dark:text-white outline-none font-bold text-sm">
            <button id="submitBtn" onclick="submitTrip()" class="w-full py-5 brand-purple text-white rounded-2xl font-black uppercase shadow-xl">Confirm & Publish</button>
        </div>
    </div>

    <div id="promoModal" class="fixed inset-0 bg-white dark:bg-zinc-900 z-[80] p-6 hidden flex-col overflow-y-auto no-scrollbar">
        <div class="flex justify-between items-center mb-6">
            <button onclick="closePromoModal()" class="w-10 h-10 bg-gray-100 dark:bg-zinc-800 rounded-full flex items-center justify-center dark:text-white">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h2 class="text-lg font-black uppercase dark:text-white">Verification</h2>
        </div>
        <div class="bg-black text-white p-8 rounded-[40px] text-center mb-6">
            <p class="text-[10px] font-bold uppercase opacity-50 mb-1">Transfer ₦5,000 to OPay</p>
            <h3 class="text-3xl font-black text-gold tracking-tight">6119361548</h3>
            <p class="text-xs font-bold uppercase mt-1">Clinton C. Oleka</p>
        </div>
        <p class="text-[11px] font-bold text-center opacity-60 mb-6 px-4">After payment, send your Driver ID (<span class="idDisplay font-black"></span>) to admin. Your badge will be ticked manually.</p>
        <button onclick="sendProof()" class="w-full py-5 bg-[#25D366] text-white rounded-2xl font-black uppercase shadow-xl flex items-center justify-center gap-3">
            <i class="fab fa-whatsapp text-xl"></i> Confirm Payment
        </button>
    </div>

    <script>
        const SUPABASE_URL = 'https://qsmfskpcthydqrvbrcfy.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzbWZza3BjdGh5ZHFydmJyY2Z5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2OTQzMjUsImV4cCI6MjA4MzI3MDMyNX0.hA0W_kpQ1Irfoj2DRu5Nv0T_8ojb2YzX9g9g_UYgpuA';
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let localRoutes = [];
        let tripHistory = JSON.parse(localStorage.getItem('kh_trip_history') || '[]');

        function switchTab(tab) {
            const active = document.getElementById('activeContent');
            const history = document.getElementById('historyContent');
            const tActive = document.getElementById('tabActive');
            const tHistory = document.getElementById('tabHistory');

            if(tab === 'active') {
                active.classList.remove('hidden'); history.classList.add('hidden');
                tActive.classList.add('border-brand', 'text-brand'); tActive.classList.remove('opacity-40');
                tHistory.classList.remove('border-brand', 'text-brand'); tHistory.classList.add('opacity-40', 'border-transparent');
            } else {
                active.classList.add('hidden'); history.classList.remove('hidden');
                tHistory.classList.add('border-brand', 'text-brand'); tHistory.classList.remove('opacity-40');
                tActive.classList.remove('border-brand', 'text-brand'); tActive.classList.add('opacity-40', 'border-transparent');
                renderHistory();
            }
        }

        function renderRoutes(routes) {
            const container = document.getElementById('route-listings');
            container.innerHTML = routes.length === 0 ? '<div class="text-center py-10 opacity-30 text-[10px] uppercase font-black">No Active Trips</div>' : '';
            routes.forEach(r => {
                container.innerHTML += `
                    <div class="glass-card p-5 rounded-[28px] border dark:border-zinc-800">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <p class="text-[8px] font-black uppercase opacity-40 mb-1">Route Info</p>
                                <h4 class="font-black text-xs uppercase dark:text-white">${r.from_loc} → ${r.to_loc}</h4>
                                <div class="flex gap-2 mt-2">
                                    <span class="bg-brand/5 text-brand text-[8px] px-2 py-1 rounded font-bold uppercase">${r.car_color || 'No Color'}</span>
                                    <span class="bg-brand/5 text-brand text-[8px] px-2 py-1 rounded font-bold uppercase">${r.plate_no || 'No Plate'}</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-[10px] font-black text-brand-light">₦${r.price}</p>
                                <span class="text-[8px] font-bold uppercase opacity-50">${r.seats || '1'} Seats</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-4 gap-2 border-t dark:border-zinc-800 pt-4">
                            <button onclick="editRoute('${r.id}', '${r.from_loc}', '${r.to_loc}', '${r.price}', '${r.whatsapp}', '${r.seats}', '${r.plate_no}', '${r.car_color}')" class="col-span-2 bg-gray-100 dark:bg-zinc-800 py-3 rounded-xl text-[10px] font-black uppercase dark:text-white">Update</button>
                            <button onclick="completeTrip('${r.id}', '${r.from_loc}', '${r.to_loc}', '${r.price}')" class="bg-green-50 dark:bg-green-900/20 text-green-600 rounded-xl flex items-center justify-center"><i class="fas fa-check text-xs"></i></button>
                            <button onclick="deleteRoute('${r.id}')" class="bg-red-50 dark:bg-red-900/20 text-red-500 rounded-xl flex items-center justify-center"><i class="fas fa-trash-alt text-xs"></i></button>
                        </div>
                    </div>`;
            });
        }

        function renderHistory() {
            const container = document.getElementById('history-list');
            container.innerHTML = tripHistory.length === 0 ? '<div class="text-center py-20 opacity-20 font-black uppercase text-[10px]">No History Yet</div>' : '';
            tripHistory.forEach(h => {
                container.innerHTML += `
                    <div class="glass-card p-4 rounded-3xl border dark:border-zinc-800">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-[7px] font-black uppercase opacity-50">${h.date}</p>
                                <h4 class="text-[10px] font-black uppercase dark:text-white">${h.from} → ${h.to}</h4>
                            </div>
                            <p class="text-xs font-black text-green-500">+₦${h.price}</p>
                        </div>
                    </div>`;
            });
            updateEarnings();
        }

        async function completeTrip(id, from, to, price) {
            if(confirm("Complete this trip?")) {
                const historyItem = { from, to, price, date: new Date().toLocaleDateString(), id: Date.now() };
                tripHistory.unshift(historyItem);
                localStorage.setItem('kh_trip_history', JSON.stringify(tripHistory));
                await client.from('listings').delete().eq('id', id);
                loadRoutes();
            }
        }

        function clearHistory() {
            if(confirm("Permanently clear your trip history and earnings?")) {
                tripHistory = [];
                localStorage.setItem('kh_trip_history', '[]');
                renderHistory();
            }
        }

        function downloadHistory() {
            if(tripHistory.length === 0) return alert("No history to download");
            let total = tripHistory.reduce((sum, item) => sum + parseInt(item.price || 0), 0);
            let text = `K-HUB DRIVER RECEIPT\nDriver ID: ${document.getElementById('driverID').innerText}\n--------------------------\n`;
            tripHistory.forEach(h => {
                text += `${h.date}: ${h.from} to ${h.to} - ₦${h.price}\n`;
            });
            text += `--------------------------\nTOTAL EARNINGS: ₦${total.toLocaleString()}`;
            const blob = new Blob([text], { type: 'text/plain' });
            const anchor = document.createElement('a');
            anchor.download = `k-hub-receipt-${Date.now()}.txt`;
            anchor.href = (window.webkitURL || window.URL).createObjectURL(blob);
            anchor.dataset.downloadurl = ['text/plain', anchor.download, anchor.href].join(':');
            anchor.click();
        }

        function updateEarnings() {
            const total = tripHistory.reduce((sum, item) => sum + parseInt(item.price || 0), 0);
            document.getElementById('totalEarnings').innerText = total.toLocaleString();
        }

        async function loadRoutes() {
            const { data } = await client.from('listings').select('*').eq('type', 'transport').order('created_at', { ascending: false });
            if (data) { localRoutes = data; document.getElementById('routeCount').innerText = data.length; renderRoutes(data); }
            updateEarnings();
        }

        async function submitTrip() {
            const id = document.getElementById('editRouteId').value;
            const payload = {
                from_loc: document.getElementById('rFrom').value,
                to_loc: document.getElementById('rTo').value,
                plate_no: document.getElementById('rPlate').value,
                car_color: document.getElementById('rColor').value,
                price: document.getElementById('rPrice').value,
                seats: document.getElementById('rSeats').value,
                whatsapp: document.getElementById('rWa').value,
                type: 'transport'
            };
            if(!payload.from_loc || !payload.plate_no) return alert("Enter route and vehicle info");
            const { error } = id ? await client.from('listings').update(payload).eq('id', id) : await client.from('listings').insert([payload]);
            if (error) alert("Error saving trip"); else { togglePostModal(); loadRoutes(); }
        }

        function togglePostModal() { 
            const m = document.getElementById('postModal'); m.classList.toggle('hidden'); m.classList.toggle('flex');
            if(m.classList.contains('hidden')) {
                document.getElementById('editRouteId').value = '';
                document.getElementById('rFrom').value = ''; document.getElementById('rTo').value = ''; 
                document.getElementById('rPlate').value = ''; document.getElementById('rColor').value = '';
                document.getElementById('rPrice').value = ''; document.getElementById('rWa').value = '';
                document.getElementById('rSeats').value = '';
            }
        }

        function editRoute(id, from, to, price, wa, seats, plate, color) {
            document.getElementById('editRouteId').value = id;
            document.getElementById('rFrom').value = from;
            document.getElementById('rTo').value = to;
            document.getElementById('rPrice').value = price;
            document.getElementById('rWa').value = wa;
            document.getElementById('rSeats').value = seats;
            document.getElementById('rPlate').value = plate;
            document.getElementById('rColor').value = color;
            document.getElementById('modalTitle').innerText = 'Edit Trip';
            togglePostModal();
        }

        async function deleteRoute(id) { if(confirm("Delete trip?")) { await client.from('listings').delete().eq('id', id); loadRoutes(); } }
        function openPromoModal() { document.getElementById('promoModal').classList.remove('hidden'); document.getElementById('promoModal').classList.add('flex'); }
        function closePromoModal() { document.getElementById('promoModal').classList.add('hidden'); }
        function sendProof() { window.open(`https://wa.me/2347051337399?text=Verification Request. ID:*${document.getElementById('driverID').innerText}*`); }
        function toggleTheme() { let d = document.getElementById('htmlTag').classList.toggle('dark'); localStorage.setItem('khub_theme', d?'dark':'light'); }
        function saveDriverProfile() { localStorage.setItem('kh_driver_name', document.getElementById('driverName').value); }
        function previewImage(i, t) { if(i.files[0]) { let r = new FileReader(); r.onload=(e)=>{document.getElementById(t).src=e.target.result;}; r.readAsDataURL(i.files[0]); } }
        function generateDriverID() {
            const id = localStorage.getItem('kh_driver_id') || 'DR-' + Math.floor(1000 + Math.random() * 9000);
            localStorage.setItem('kh_driver_id', id);
            document.getElementById('driverID').innerText = id;
            document.querySelectorAll('.idDisplay').forEach(el => el.innerText = id);
        }
        function updateAvailability() {
            const isOnline = document.getElementById('availToggle').checked;
            document.getElementById('statusLabel').innerText = isOnline ? 'Online' : 'Offline';
            document.getElementById('availDesc').innerText = isOnline ? 'You are visible to riders' : 'Riders cannot see your routes';
            document.getElementById('availDesc').className = isOnline ? 'text-[9px] font-bold text-green-500' : 'text-[9px] font-bold text-red-500';
        }

        window.onload = () => {
            if (localStorage.getItem('khub_theme') === 'dark') document.getElementById('htmlTag').classList.add('dark');
            generateDriverID();
            loadRoutes();
            updateAvailability();
            document.getElementById('driverName').value = localStorage.getItem('kh_driver_name') || '';
        };
    </script>
</body>
</html>
